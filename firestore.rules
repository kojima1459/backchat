rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ヘルパー関数
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isParticipant(roomId) {
      return isSignedIn() && 
        request.auth.uid in get(/databases/$(database)/documents/rooms/$(roomId)).data.participantUids;
    }
    
    function isNotDeleted(roomId) {
      return get(/databases/$(database)/documents/rooms/$(roomId)).data.deletedAt == null;
    }
    
    // rooms コレクション
    match /rooms/{roomId} {
      function affectedKeysAre(keys) {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(keys);
      }

      function isRoomParticipant() {
        return isSignedIn() && request.auth.uid in resource.data.participantUids;
      }

      function isRoomNotDeleted() {
        return resource.data.deletedAt == null;
      }

      function isJoinUpdate() {
        return isRoomNotDeleted() &&
          affectedKeysAre(['participantUids', 'updatedAt']) &&
          !(request.auth.uid in resource.data.participantUids) &&
          request.auth.uid in request.resource.data.participantUids &&
          resource.data.participantUids.size() < 2 &&
          request.resource.data.participantUids.size() == resource.data.participantUids.size() + 1 &&
          request.resource.data.participantUids.hasAll(resource.data.participantUids);
      }

      function isLeaveUpdate() {
        return isRoomNotDeleted() &&
          affectedKeysAre(['participantUids', 'updatedAt']) &&
          request.auth.uid in resource.data.participantUids &&
          !(request.auth.uid in request.resource.data.participantUids) &&
          request.resource.data.participantUids.size() == resource.data.participantUids.size() - 1 &&
          resource.data.participantUids.hasAll(request.resource.data.participantUids);
      }

      function isMessageTimestampUpdate() {
        return isRoomNotDeleted() &&
          affectedKeysAre(['lastMessageAt', 'updatedAt']) &&
          isRoomParticipant();
      }

      function isSoftDeleteUpdate() {
        return isRoomNotDeleted() &&
          affectedKeysAre(['deletedAt', 'updatedAt']) &&
          isRoomParticipant() &&
          request.resource.data.deletedAt != null;
      }

      // list: 禁止（ルーム一覧は取得不可）
      allow list: if false;
      
      // get: サインイン済みなら許可（初回Join判定のため）
      allow get: if isSignedIn();
      
      // create: サインイン済みで、自分が参加者に含まれている場合
      allow create: if isSignedIn() && 
        request.auth.uid in request.resource.data.participantUids &&
        request.resource.data.participantUids.size() == 1;
      
      // update: 参加・退出・メッセージ時刻・論理削除のみ
      allow update: if isSignedIn() && (
        isJoinUpdate() ||
        isLeaveUpdate() ||
        isMessageTimestampUpdate() ||
        isSoftDeleteUpdate()
      );
      
      // delete: 禁止（論理削除のみ）
      allow delete: if false;
      
      // messages サブコレクション
      match /messages/{messageId} {
        // list/get: 参加者のみ（リアルタイム購読のため）
        allow list, get: if isParticipant(roomId) && isNotDeleted(roomId);
        
        // create: 参加者のみ、自分が送信者
        allow create: if isParticipant(roomId) && 
          isNotDeleted(roomId) &&
          request.resource.data.senderUid == request.auth.uid &&
          request.auth.uid in request.resource.data.readBy;
        
        // update: 参加者のみ（既読更新）
        allow update: if isParticipant(roomId) && isNotDeleted(roomId);
        
        // delete: 参加者のみ（既読後の削除）
        allow delete: if isParticipant(roomId);
      }
    }
  }
}
